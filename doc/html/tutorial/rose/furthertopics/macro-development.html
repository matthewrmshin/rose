



<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Custom Macros &mdash; Rose Documentation 2018.02.0-312-g3cbcacce documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../../_static/css/rtd-theme-fix.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="Rose Documentation 2018.02.0-312-g3cbcacce documentation" href="../../../index.html"/>
        <link rel="up" title="Further Topics" href="index.html"/>
        <link rel="next" title="Optional Configurations" href="optional-configurations.html"/>
        <link rel="prev" title="Fail-If, Warn-If" href="failif-warnif.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Rose Documentation
          

          
          </a>

          
            
            
              <div class="version">
                2018.02.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cylc/index.html">Cylc Tutorial</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Rose Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../configurations.html">Rose Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../applications.html">Rose Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metadata.html">Rose Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../suites.html">Rose Suite Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rosie.html">Rosie</a></li>
<li class="toctree-l2"><a class="reference internal" href="../summary.html">Summary</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Further Topics</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="command-keys.html">Command Keys</a></li>
<li class="toctree-l3"><a class="reference internal" href="date-time-manipulation.html">Date and Time Manipulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="failif-warnif.html">Fail-If, Warn-If</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Custom Macros</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#warning">Warning</a></li>
<li class="toctree-l4"><a class="reference internal" href="#purpose">Purpose</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example">Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#macro-arguments">Macro Arguments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#metadata-option">Metadata Option</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="optional-configurations.html">Optional Configurations</a></li>
<li class="toctree-l3"><a class="reference internal" href="polling.html">Polling</a></li>
<li class="toctree-l3"><a class="reference internal" href="rose-arch.html">Rose Arch</a></li>
<li class="toctree-l3"><a class="reference internal" href="rose-bunch.html">Rose Bunch</a></li>
<li class="toctree-l3"><a class="reference internal" href="rose-stem.html">Rose Stem</a></li>
<li class="toctree-l3"><a class="reference internal" href="trigger.html">Trigger</a></li>
<li class="toctree-l3"><a class="reference internal" href="upgrading.html">Upgrading</a></li>
<li class="toctree-l3"><a class="reference internal" href="upgrading-macro-development.html">Upgrading Macro Development</a></li>
<li class="toctree-l3"><a class="reference internal" href="widget-development.html">Widget Development</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../cheat-sheet.html">Cheat Sheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
</ul>
<p class="caption"><span class="caption-text">Rose API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/command-reference.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/configuration.html">Rose Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/environment-variables.html">Rose Environment Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/rose-bash-library.html">Rose Bash Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/rose-built-in-applications.html">Rose Built-In Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/rose-gtk-library.html">Rose GTK library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/rose-macro.html">Rose Macro API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/rose-upgrader-macros.html">Rose Upgrade Macro API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/rosie-web.html">Rosie Web API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../terms.html">Rose Terms Of Use</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Rose Documentation</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Rose Tutorial</a> &raquo;</li>
        
          <li><a href="index.html">Further Topics</a> &raquo;</li>
        
      <li>Custom Macros</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="custom-macros">
<span id="macro-dev"></span><h1>Custom Macros<a class="headerlink" href="#custom-macros" title="Permalink to this headline">¶</a></h1>
<p>Rose macros are custom python modules which can perform checking
beyond that which (e.g. <code class="docutils literal notranslate"><span class="pre">type</span></code>, <code class="docutils literal notranslate"><span class="pre">range</span></code>, <code class="docutils literal notranslate"><span class="pre">warn-if</span></code>, etc)
can provide.</p>
<p>This tutorial covers the development of checking (<strong>validator</strong>),
changing (<strong>transformer</strong>) and reporting (<strong>reporter</strong>) macros.</p>
<div class="section" id="warning">
<h2>Warning<a class="headerlink" href="#warning" title="Permalink to this headline">¶</a></h2>
<p>Macros should <strong>only</strong> be written if there is a genuine need that is not
covered by <a class="reference internal" href="../../../api/configuration/metadata.html#metadata-values"><span class="std std-ref">other metadata</span></a> - make sure you are
familiar with <a class="reference internal" href="../../../api/configuration/metadata.html#conf-meta"><span class="std std-ref">Configuration Metadata</span></a> before you write your own (real-life)
macros.</p>
<p>For example, <code class="docutils literal notranslate"><span class="pre">fail-if</span></code> and <code class="docutils literal notranslate"><span class="pre">warn-if</span></code> metadata options can perform
complex inter-setting validation. See the
<a class="reference internal" href="failif-warnif.html#tutorial-rose-fail-if-warn-if"><span class="std std-ref">tutorial</span></a> for details.</p>
</div>
<div class="section" id="purpose">
<h2>Purpose<a class="headerlink" href="#purpose" title="Permalink to this headline">¶</a></h2>
<p>Macros are used in Rose to report problems with a configuration,
and to change it. Nearly all metadata mechanics (checking vs metadata
settings, and changing - e.g. <code class="docutils literal notranslate"><span class="pre">trigger</span></code>) are performed within Rose
by the Rose built-in macros.</p>
<p>Custom macros are user-defined, but follow exactly the same API - they
are just in a different filespace location. They can be invoked via
the command line (<a class="reference internal" href="../../../api/command-reference.html#command-rose-macro"><span class="std std-ref">rose macro</span></a>) or from within the
<span class="menuselection">Metadata</span> menu in the config editor.</p>
</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>For these examples we will create an example app called
<code class="docutils literal notranslate"><span class="pre">macro_tutorial_app</span></code> that could be part of a typical suite.</p>
<p>Create a directory for your suite app called <code class="docutils literal notranslate"><span class="pre">macro_tutorial_app</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">~/</span><span class="n">rose</span><span class="o">-</span><span class="n">tutorial</span><span class="o">/</span><span class="n">macro_tutorial_app</span>
</pre></div>
</div>
<p>Inside the <code class="docutils literal notranslate"><span class="pre">macro_tutorial_app</span></code> directory, create a <a class="reference internal" href="../../../api/configuration/application.html#rose:file:rose-app.conf" title="rose:file:rose-app.conf"><code class="xref rose rose-file docutils literal notranslate"><span class="pre">rose-app.conf</span></code></a>
file and paste in the following contents:</p>
<div class="highlight-rose notranslate"><div class="highlight"><pre><span></span><span class="nt">[command]</span>
<span class="nv">default</span><span class="o">=</span><span class="s">echo &quot;Hello $WORLD!&quot;</span>

<span class="nt">[env]</span>
<span class="nv">WORLD</span><span class="o">=</span><span class="s">Earth</span>
</pre></div>
</div>
<p>The metadata for the app lives under the <code class="docutils literal notranslate"><span class="pre">meta/</span></code> sub directory.
Our new macro will live with the metadata.</p>
<p>For this example, we want to check the value of the option
<code class="docutils literal notranslate"><span class="pre">env=WORLD</span></code> in our <code class="docutils literal notranslate"><span class="pre">macro_tutorial_app</span></code> application. Specifically,
for this example, we want our macro to give us an error if the ‘world’
is too far away from Earth.</p>
<p>Create the directories <code class="docutils literal notranslate"><span class="pre">meta/lib/python/macros/</span></code> by running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="n">meta</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">macros</span>
</pre></div>
</div>
<p>Create an empty file called <a class="reference internal" href="../../../api/configuration/metadata.html#rose:file:rose-meta.conf" title="rose:file:rose-meta.conf"><code class="xref rose rose-file docutils literal notranslate"><span class="pre">rose-meta.conf</span></code></a> in the directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">touch</span> <span class="n">meta</span><span class="o">/</span><span class="n">rose</span><span class="o">-</span><span class="n">meta</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>Create an empty file called <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> in the directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">touch</span> <span class="n">meta</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">macros</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>Finally, create a file called <code class="docutils literal notranslate"><span class="pre">planet.py</span></code> in the directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">touch</span> <span class="n">meta</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">macros</span><span class="o">/</span><span class="n">planet</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<div class="section" id="validator-macro">
<h3>Validator Macro<a class="headerlink" href="#validator-macro" title="Permalink to this headline">¶</a></h3>
<p>Open <code class="docutils literal notranslate"><span class="pre">planet.py</span></code> in a text editor and paste in the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="kn">import</span> <span class="nn">rose.macro</span>


<span class="k">class</span> <span class="nc">PlanetChecker</span><span class="p">(</span><span class="n">rose</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">MacroBase</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Checks option values that refer to planets.&quot;&quot;&quot;</span>

    <span class="n">opts_to_check</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;WORLD&quot;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">meta_config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of errors, if any.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts_to_check</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">is_ignored</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="c1"># Check the option value (node.value) here</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span>
</pre></div>
</div>
<p>This is the bare bones of a Rose macro - a bit of Python that is a
subclass of <a class="reference internal" href="../../../api/rose-macro.html#rose.macro.MacroBase" title="rose.macro.MacroBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">rose.macro.MacroBase</span></code></a>. At the moment, it doesn’t
do anything.</p>
<p>We need to check the value of the option (<code class="docutils literal notranslate"><span class="pre">env=WORLD</span></code>) in our
app configuration. To do this, we’ll generate a list of allowed
‘planet’ choices that aren’t too far away from Earth at the moment.</p>
<p>Call a method to get the choices by adding the line:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">allowed_planets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_allowed_planets</span><span class="p">()</span>
</pre></div>
</div>
<p>at the top of the <code class="docutils literal notranslate"><span class="pre">validate</span></code> method, so it looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">meta_config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a list of errors, if any.&quot;&quot;&quot;</span>
    <span class="n">allowed_planets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_allowed_planets</span><span class="p">()</span>
</pre></div>
</div>
<p>Now add the method <code class="docutils literal notranslate"><span class="pre">_get_allowed_planets</span></code> to the class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_get_allowed_planets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Retrieve planets less than a certain distance away.</span>
    <span class="n">cmd_strings</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;curl&quot;</span><span class="p">,</span> <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;http://www.heavens-above.com/planetsummary.aspx&quot;</span><span class="p">]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd_strings</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">planets</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;(\w+)&lt;/td&gt;&quot;</span><span class="p">,</span>
                         <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;(?s)^.*(tablehead.*?ascension).*$&#39;</span><span class="p">,</span>
                                <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;([\d.]+)&lt;/td&gt;&quot;</span><span class="p">,</span>
                           <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;(?s)^.*(Range.*?Brightness).*$&#39;</span><span class="p">,</span>
                                  <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">planet</span><span class="p">,</span> <span class="n">distance</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">planets</span><span class="p">,</span> <span class="n">distances</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">5.0</span><span class="p">:</span>
            <span class="c1"># The planet is more than 5 AU away.</span>
            <span class="n">planets</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">planet</span><span class="p">)</span>
    <span class="n">planets</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;Earth&quot;</span><span class="p">]</span>  <span class="c1"># Distance ~ 0</span>
    <span class="k">return</span> <span class="n">planets</span>
</pre></div>
</div>
<p>This will give us a list of valid (nearby) solar system planets which
our configuration option should be in. If it isn’t, we need to send a
message explaining the problem. Add:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">error_text</span> <span class="o">=</span> <span class="s2">&quot;planet is too far away.&quot;</span>
</pre></div>
</div>
<p>at the top of the class, like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PlanetChecker</span><span class="p">(</span><span class="n">rose</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">MacroBase</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Checks option values that refer to planets.&quot;&quot;&quot;</span>

    <span class="n">error_text</span> <span class="o">=</span> <span class="s2">&quot;planet is too far away.&quot;</span>
    <span class="n">opts_to_check</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;WORLD&quot;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">meta_config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of errors, if any.&quot;&quot;&quot;</span>
        <span class="n">allowed_planets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_allowed_planets</span><span class="p">()</span>
</pre></div>
</div>
<p>Finally, we need to check if the configuration option is in the list,
by replacing</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check the option value (node.value) here</span>
</pre></div>
</div>
<p>with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_planets</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_report</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_text</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">self.add_report</span></code> call is invoked when the planet choice the
user has made is not in the allowed planets. It adds the error
information about the section and option (<code class="docutils literal notranslate"><span class="pre">env</span></code> and <code class="docutils literal notranslate"><span class="pre">WORLD</span></code>)
to the <code class="docutils literal notranslate"><span class="pre">self.reports</span></code> list, which is returned to the rest of
Rose to see if the macro reports any problems.</p>
<p>Your final macro should look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="kn">import</span> <span class="nn">rose.macro</span>


<span class="k">class</span> <span class="nc">PlanetChecker</span><span class="p">(</span><span class="n">rose</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">MacroBase</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Checks option values that refer to planets.&quot;&quot;&quot;</span>

    <span class="n">error_text</span> <span class="o">=</span> <span class="s2">&quot;planet is too far away.&quot;</span>
    <span class="n">opts_to_check</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;WORLD&quot;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">meta_config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of errors, if any.&quot;&quot;&quot;</span>
        <span class="n">allowed_planets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_allowed_planets</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts_to_check</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">is_ignored</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_planets</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_report</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_text</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span>

    <span class="k">def</span> <span class="nf">_get_allowed_planets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Retrieve planets less than a certain distance away.</span>
        <span class="n">cmd_strings</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;curl&quot;</span><span class="p">,</span> <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;http://www.heavens-above.com/planetsummary.aspx&quot;</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd_strings</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">planets</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;(\w+)&lt;/td&gt;&quot;</span><span class="p">,</span>
                             <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?s)^.*(&lt;thead.*?ascension).*$&#39;</span><span class="p">,</span>
                                    <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;([\d.]+)&lt;/td&gt;&quot;</span><span class="p">,</span>
                               <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;(?s)^.*(Range.*?Brightness).*$&#39;</span><span class="p">,</span>
                                      <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">planet</span><span class="p">,</span> <span class="n">distance</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">planets</span><span class="p">,</span> <span class="n">distances</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">5.0</span><span class="p">:</span>
                <span class="c1"># The planet is more than 5 AU away.</span>
                <span class="n">planets</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">planet</span><span class="p">)</span>
        <span class="n">planets</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;Earth&quot;</span><span class="p">]</span>  <span class="c1"># Distance ~ 0</span>
        <span class="k">return</span> <span class="n">planets</span>
</pre></div>
</div>
<div class="section" id="results">
<h4>Results<a class="headerlink" href="#results" title="Permalink to this headline">¶</a></h4>
<p>Your validator macro is now ready to use.</p>
<p>Run the config editor with the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rose</span> <span class="n">edit</span>
</pre></div>
</div>
<p>in the application directory. Navigate to the <code class="docutils literal notranslate"><span class="pre">env</span></code> page, and
change the option <code class="docutils literal notranslate"><span class="pre">env=WORLD</span></code> to <code class="docutils literal notranslate"><span class="pre">Jupiter</span></code>.</p>
<p>To run the macro, select the menu
<span class="menuselection">Metadata ‣ macro_tutorial_app ‣
planet.PlanetChecker.validate</span>.</p>
<p>It should either return an “OK” dialog, or give an error dialog
like the one below depending on the current Earth-Jupiter distance.</p>
<a class="reference internal image-reference" href="../../../_images/rose-macro-tutorial-app-fail.png"><img alt="Screenshot of a Rose macro failure message." class="align-center" src="../../../_images/rose-macro-tutorial-app-fail.png" style="width: 350px;" /></a>
<p>If there is an error, the variable should display an error icon on
the <code class="docutils literal notranslate"><span class="pre">env</span></code> page, which you can hover-over to get the error text as in
the screenshot below. You can remove the error by fixing the value and
re-running your macro.</p>
<a class="reference internal image-reference" href="../../../_images/rose-edit-macro-fail.png"><img alt="Screenshot of setting with an error detected by a Rose macro." class="align-center" src="../../../_images/rose-edit-macro-fail.png" style="width: 450px;" /></a>
<p>Try changing the value of <code class="docutils literal notranslate"><span class="pre">env=WORLD</span></code> to other solar system planets
and re-running the macro.</p>
<p>You can also run your macro from the command line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rose</span> <span class="n">macro</span> <span class="n">planet</span><span class="o">.</span><span class="n">PlanetChecker</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="transformer-macro">
<h3>Transformer Macro<a class="headerlink" href="#transformer-macro" title="Permalink to this headline">¶</a></h3>
<p>We’ll now make a macro that changes the configuration. Our example
will change the value of <code class="docutils literal notranslate"><span class="pre">env=WORLD</span></code> to something else.</p>
<p>Open <code class="docutils literal notranslate"><span class="pre">planet.py</span></code> in a text editor and append the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PlanetChanger</span><span class="p">(</span><span class="n">rose</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">MacroBase</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Switch between planets.&quot;&quot;&quot;</span>

    <span class="n">change_text</span> <span class="o">=</span> <span class="s1">&#39;{0} to {1}&#39;</span>
    <span class="n">opts_to_change</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;WORLD&quot;</span><span class="p">)]</span>
    <span class="n">planets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Mercury&quot;</span><span class="p">,</span> <span class="s2">&quot;Venus&quot;</span><span class="p">,</span> <span class="s2">&quot;Earth&quot;</span><span class="p">,</span> <span class="s2">&quot;Mars&quot;</span><span class="p">,</span> <span class="s2">&quot;Jupiter&quot;</span><span class="p">,</span> <span class="s2">&quot;Saturn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Uranus&quot;</span><span class="p">,</span> <span class="s2">&quot;Neptune&quot;</span><span class="p">,</span> <span class="s2">&quot;Eris&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">meta_config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform configuration and return it with a list of changes.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts_to_change</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">])</span>
            <span class="c1"># Do something to the configuration.</span>
        <span class="k">return</span> <span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span>
</pre></div>
</div>
<p>This is another bare-bones macro class, although this time it supplies
a <code class="docutils literal notranslate"><span class="pre">transform</span></code> method instead of a <code class="docutils literal notranslate"><span class="pre">validate</span></code> method.</p>
<p>You can see that it returns a configuration object (<code class="docutils literal notranslate"><span class="pre">config</span></code>) as well
as <code class="docutils literal notranslate"><span class="pre">self.reports</span></code>. This means that you can modify the configuration
e.g. by adding or deleting a variable and then returning the changed
config object.</p>
<p>We need to add some code to make some changes to the configuration.</p>
<p>Replace the line:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do something to the configuration.</span>
</pre></div>
</div>
<p>with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">is_ignored</span><span class="p">():</span>
    <span class="k">continue</span>
<span class="n">old_planet</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">old_planet</span><span class="p">)</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
    <span class="n">new_planet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">new_planet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="p">[(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="p">)]</span>
<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">],</span> <span class="n">new_planet</span><span class="p">)</span>
</pre></div>
</div>
<p>This changes the option <code class="docutils literal notranslate"><span class="pre">env=WORLD</span></code> to the next planet on the list.
It will set it to the first planet on the list if it is something else.
It will skip it if it is missing or ignored.</p>
<p>We also need to add a change message to flag what we’ve changed.</p>
<p>Beneath the line:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">],</span> <span class="n">new_planet</span><span class="p">)</span>
</pre></div>
</div>
<p>add the following two lines:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_text</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_planet</span><span class="p">,</span> <span class="n">new_planet</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">add_report</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">new_planet</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
<p>This makes use of the template <code class="docutils literal notranslate"><span class="pre">self.change_text</span></code> at the top of
the class. The message will be used to provide more information to
the user about the change.</p>
<p>Your class should now look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PlanetChanger</span><span class="p">(</span><span class="n">rose</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">MacroBase</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Switch between planets.&quot;&quot;&quot;</span>

    <span class="n">change_text</span> <span class="o">=</span> <span class="s1">&#39;{0} to {1}&#39;</span>
    <span class="n">opts_to_change</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;WORLD&quot;</span><span class="p">)]</span>
    <span class="n">planets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Mercury&quot;</span><span class="p">,</span> <span class="s2">&quot;Venus&quot;</span><span class="p">,</span> <span class="s2">&quot;Earth&quot;</span><span class="p">,</span> <span class="s2">&quot;Mars&quot;</span><span class="p">,</span> <span class="s2">&quot;Jupiter&quot;</span><span class="p">,</span> <span class="s2">&quot;Saturn&quot;</span><span class="p">,</span>
               <span class="s2">&quot;Uranus&quot;</span><span class="p">,</span> <span class="s2">&quot;Neptune&quot;</span><span class="p">,</span> <span class="s2">&quot;Eris&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">meta_config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform configuration and return it with a list of changes.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts_to_change</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">is_ignored</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">old_planet</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">old_planet</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">new_planet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_planet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="p">[(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="p">)]</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">],</span> <span class="n">new_planet</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_text</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_planet</span><span class="p">,</span> <span class="n">new_planet</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_report</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">new_planet</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span>
</pre></div>
</div>
<p>Your transform macro is now ready to use.</p>
<p>You can run it from <a class="reference internal" href="../../../api/command-reference.html#command-rose-config-edit"><span class="std std-ref">rose config-edit</span></a> via the menu
<span class="menuselection">metadata ‣ macro_tutorial_app ‣ planet.PlanetChanger.transform</span>.</p>
<p>It should give a dialog explaining the changes it’s made and asking
for permission to apply them. If you click OK, the changes will be
applied and the value of <code class="docutils literal notranslate"><span class="pre">env=WORLD</span></code> will be changed. You can Undo
and Redo macro changes.</p>
<p>Try running the macro once or twice more to see it change the configuration.</p>
<p>You can also run your macro from the command line in the application
directory by invoking <code class="docutils literal notranslate"><span class="pre">rose</span> <span class="pre">macro</span> <span class="pre">planet.PlanetChanger</span></code>.</p>
</div>
<div class="section" id="reporter-macro">
<h3>Reporter Macro<a class="headerlink" href="#reporter-macro" title="Permalink to this headline">¶</a></h3>
<p>Along with validator and transformer macros there are also reporter
macros. These are used when you want to output information about a
configuration but do not want to make any changes to it.</p>
<p>Next we will write a reporter macro which produces a horoscope
entry based on the value of <code class="docutils literal notranslate"><span class="pre">env=WORLD</span></code>.</p>
<p>Open <code class="docutils literal notranslate"><span class="pre">planet.py</span></code> and paste in this text:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PlanetReporter</span><span class="p">(</span><span class="n">rose</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">MacroBase</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Creates a report on the value of env=WORLD.&quot;&quot;&quot;</span>

    <span class="n">GENERIC_HOROSCOPE_STATEMENTS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;be cautious&#39;</span><span class="p">,</span> <span class="s1">&#39;remain indoors&#39;</span><span class="p">,</span> <span class="s1">&#39;expect the unexpected&#39;</span><span class="p">,</span>
        <span class="s1">&#39;not walk under ladders&#39;</span><span class="p">,</span> <span class="s1">&#39;seek new opportunities&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">meta_config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">world_node</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;WORLD&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">world_node</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">world_node</span><span class="o">.</span><span class="n">is_ignored</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">planet</span> <span class="o">=</span> <span class="n">world_node</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">planet</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;earth&#39;</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;Please choose a planet other than Earth.&#39;</span>
            <span class="k">return</span>
        <span class="n">constellation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_planet_info</span><span class="p">(</span><span class="n">planet</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">constellation</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;Could not find horoscope entry for {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">planet</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="p">(</span>
                <span class="s1">&#39;{planet} is currently passing through {constellation}.</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;You should {generic_message} today.&#39;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">planet</span> <span class="o">=</span> <span class="n">planet</span><span class="p">,</span>
                <span class="n">constellation</span> <span class="o">=</span> <span class="n">constellation</span><span class="p">,</span>
                <span class="n">generic_message</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">GENERIC_HOROSCOPE_STATEMENTS</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_planet_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">planet_name</span><span class="p">):</span>
        <span class="n">cmd_strings</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;curl&quot;</span><span class="p">,</span> <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;http://www.heavens-above.com/planetsummary.aspx&quot;</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd_strings</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">planets</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;(\w+)&lt;/td&gt;&quot;</span><span class="p">,</span>
                             <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?s)^.*(&lt;thead.*?ascension).*$&#39;</span><span class="p">,</span>
                                    <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
        <span class="n">constellations</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;(\w+)&lt;/a&gt;&quot;</span><span class="p">,</span>
                               <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;(?s)^.*(Constellation.*?Meridian).*$&#39;</span><span class="p">,</span>
                                      <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">planet</span><span class="p">,</span> <span class="n">constellation</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">planets</span><span class="p">,</span> <span class="n">constellations</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">planet</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">planet_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">constellation</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></div>
</div>
<p>You will need to add the following line with the other imports at the
top of the file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
</pre></div>
</div>
<p>Next run this macro from the command line by invoking:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rose</span> <span class="n">macro</span> <span class="n">planet</span><span class="o">.</span><span class="n">PlanetReporter</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="macro-arguments">
<h2>Macro Arguments<a class="headerlink" href="#macro-arguments" title="Permalink to this headline">¶</a></h2>
<p>From time to time, we may want to change some macro settings.
Rather than altering the macro each time or creating a separate
macro for every possible setting, we can make use of Python keyword
arguments.</p>
<p>We will alter the transformer macro to allow us to specify the name
of the planet we want to use.</p>
<p>Open <code class="docutils literal notranslate"><span class="pre">planet.py</span></code> and alter the <code class="docutils literal notranslate"><span class="pre">PlanetChanger</span></code> class to look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PlanetChanger</span><span class="p">(</span><span class="n">rose</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">MacroBase</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Switch between planets.&quot;&quot;&quot;</span>

    <span class="n">change_text</span> <span class="o">=</span> <span class="s1">&#39;{0} to {1}&#39;</span>
    <span class="n">opts_to_change</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;WORLD&quot;</span><span class="p">)]</span>
    <span class="n">planets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Mercury&quot;</span><span class="p">,</span> <span class="s2">&quot;Venus&quot;</span><span class="p">,</span> <span class="s2">&quot;Earth&quot;</span><span class="p">,</span> <span class="s2">&quot;Mars&quot;</span><span class="p">,</span> <span class="s2">&quot;Jupiter&quot;</span><span class="p">,</span> <span class="s2">&quot;Saturn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Uranus&quot;</span><span class="p">,</span> <span class="s2">&quot;Neptune&quot;</span><span class="p">,</span> <span class="s2">&quot;Eris&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">meta_config</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">planet_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform configuration and return it with a list of changes.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts_to_change</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">is_ignored</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">old_planet</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span>
            <span class="k">if</span> <span class="n">planet_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">old_planet</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="n">new_planet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_planet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="p">[(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_planet</span> <span class="o">=</span> <span class="n">planet_name</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">],</span> <span class="n">new_planet</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_text</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_planet</span><span class="p">,</span> <span class="n">new_planet</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_report</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">new_planet</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span>
</pre></div>
</div>
<p>This adds the <code class="docutils literal notranslate"><span class="pre">planet_name</span></code> argument to the transform method with
a default value of <code class="docutils literal notranslate"><span class="pre">None</span></code>. On running the macro it will give you
the option to specify a value for <code class="docutils literal notranslate"><span class="pre">planet_name</span></code>. If you do, then
that will be used as the new planet.</p>
<p>Save your changes and run the transformer macro either from the
command line or <a class="reference internal" href="../../../api/command-reference.html#command-rose-config-edit"><span class="std std-ref">rose config-edit</span></a>. You should be prompted to
provide a value for <code class="docutils literal notranslate"><span class="pre">planet_name</span></code>. At the command line this will take the
form of a prompt while in <a class="reference internal" href="../../../api/command-reference.html#command-rose-config-edit"><span class="std std-ref">rose config-edit</span></a> you will be presented
with a dialog to enter values in, with defaults already entered for you.</p>
<p>Specify a value to use for <code class="docutils literal notranslate"><span class="pre">planet_name</span></code> using a quoted string,
e.g. <code class="docutils literal notranslate"><span class="pre">&quot;Vulcan&quot;</span></code> and accept the proposed changes. The <code class="docutils literal notranslate"><span class="pre">WORLD</span></code>
variable should now be set to <code class="docutils literal notranslate"><span class="pre">Vulcan</span></code>. Check your configuration
to confirm this.</p>
</div>
<div class="section" id="metadata-option">
<h2>Metadata Option<a class="headerlink" href="#metadata-option" title="Permalink to this headline">¶</a></h2>
<p>If a macro addresses particular sections, namespaces, or options,
then it makes sense to write the relationship down in the metadata
for the particular settings. You can do this using the <code class="docutils literal notranslate"><span class="pre">macro</span></code>
metadata option.</p>
<p>For example, our validator and transformer macros above are both
specific to <code class="docutils literal notranslate"><span class="pre">env=WORLD</span></code>. Open the file
<code class="docutils literal notranslate"><span class="pre">macro_tutorial_app/meta/rose-meta.conf</span></code> in a text editor, and
add the following lines</p>
<div class="highlight-rose notranslate"><div class="highlight"><pre><span></span><span class="nt">[env=WORLD]</span>
<span class="nv">macro</span><span class="o">=</span><span class="s">planet.PlanetChecker, planet.PlanetChanger</span>
</pre></div>
</div>
<p>Close the config editor if it is still open, and open the app in the
config editor again. The env page should now contain a dropdown menu
at the top of the page for launching the two macros.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="optional-configurations.html" class="btn btn-neutral float-right" title="Optional Configurations" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="failif-warnif.html" class="btn btn-neutral" title="Fail-If, Warn-If" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright : British Crown Copyright 2012-8 Met Office. See Terms of Use. This document is released under the Open Government Licence.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'2018.02.0-312-g3cbcacce',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../_static/js/minicylc.js"></script>
      <script type="text/javascript" src="../../../_static/js/spoiler.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="../../../_static/js/rtd-theme-extensions.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>