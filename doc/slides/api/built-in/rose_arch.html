

<!DOCTYPE html>


<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>rose_arch &mdash; Rose Documentation 2018.02.0-312-g3cbcacce documentation</title>
    
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/styles.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/single.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <link rel="stylesheet" href="../../_static/css/slides-custom.css" type="text/css" />
    
    
    
    <link rel="stylesheet" href="../../_static/css/rtd-theme-fix.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2018.02.0-312-g3cbcacce',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/js/minicylc.js"></script>
    <script type="text/javascript" src="../../_static/js/spoiler.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/js/rtd-theme-extensions.js"></script>
    <script type="text/javascript" src="../../_static/common.js"></script>
    
    <script type="text/javascript" src="../../_static/slides.js"></script>
    <script type="text/javascript" src="../../_static/sync.js"></script>
    <script type="text/javascript" src="../../_static/controller.js"></script>
    <script type="text/javascript" src="../../_static/init.js"></script>
    
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="top" title="Rose Documentation 2018.02.0-312-g3cbcacce documentation" href="../../index.html" />
    <link rel="up" title="Rose Built-In Applications" href="../rose-built-in-applications.html" />
    <link rel="next" title="rose_bunch" href="rose_bunch.html" />
    <link rel="prev" title="rose_ana" href="rose_ana.html" /> 
  </head>
  <body>

<section
   id="slide_container"
   class='slides layout-regular'>


  
<article class="slide level-1" id="rose-arch">

<h1><code class="docutils literal notranslate"><span class="pre">rose_arch</span></code><a class="headerlink" href="../../../html/api/built-in/rose_arch.html#rose-arch" title="View HTML">ยง</a></h1>

<p>This built-in application provides a generic solution to configure
site-specific archiving of suite files. It is designed to work under
<a class="reference internal" href="../command-reference.html#command-rose-task-run"><span class="std std-ref">rose task-run</span></a>.</p>
<p>The application is normally configured in a <a class="reference internal" href="../configuration/application.html#rose:file:rose-app.conf" title="rose:file:rose-app.conf"><code class="xref rose rose-file docutils literal notranslate"><span class="pre">rose-app.conf</span></code></a>. Global
settings may be specified in an <a class="reference internal" href="#rose:conf:rose_arch[arch]" title="rose:conf:rose_arch[arch]"><code class="xref rose rose-conf docutils literal notranslate"><span class="pre">rose_arch[arch]</span></code></a>
section. Each archiving target will have its own <code class="docutils literal notranslate"><span class="pre">[arch:TARGET]</span></code>
section for specific settings, where <code class="docutils literal notranslate"><span class="pre">TARGET</span></code> would be a URI to
the archiving location on your site-specific archiving system. Settings
in a <code class="docutils literal notranslate"><span class="pre">[arch:TARGET]</span></code> section would override those in the global
<a class="reference internal" href="#rose:conf:rose_arch[arch]" title="rose:conf:rose_arch[arch]"><code class="xref rose rose-conf docutils literal notranslate"><span class="pre">rose_arch[arch]</span></code></a> section for the given <code class="docutils literal notranslate"><span class="pre">TARGET</span></code>.</p>
<p>A target is considered compulsory, i.e. it must have at least one
source, unless it is specified with the syntax <code class="docutils literal notranslate"><span class="pre">[arch:(TARGET)]</span></code>.
In which case, <code class="docutils literal notranslate"><span class="pre">TARGET</span></code> is considered optional. The application will
skip an optional target that has no actual source.</p>
<p>The application provides some useful functionalities:</p>
<ul class="simple">
<li>Incremental mode: store the archive target settings, checksums of
source files and the return code of archive command. In a retry, it
would only redo targets that did not succeed in the previous attempts.</li>
<li>Rename source files.</li>
<li>Tar-Gzip or Gzip source files before sending them to the archive.</li>
</ul>




</article>
<article class="slide level-2" id="invocation">

<h2>Invocation<a class="headerlink" href="../../../html/api/built-in/rose_arch.html#invocation" title="View HTML">ยง</a></h2>

<p>In automatic selection mode, this built-in application will be invoked
automatically if a task has a name that starts with <code class="docutils literal notranslate"><span class="pre">rose_arch*</span></code>.</p>




</article>
<article class="slide level-2" id="example">

<h2>Example<a class="headerlink" href="../../../html/api/built-in/rose_arch.html#example" title="View HTML">ยง</a></h2>

<div class="highlight-rose notranslate"><div class="highlight"><pre><span></span><span class="c1"># General settings</span>
<span class="nt">[arch]</span>
<span class="nv">command-format</span><span class="o">=</span><span class="s">foo put %(target)s %(sources)s</span>
<span class="nv">source-prefix</span><span class="o">=</span><span class="s">$ROSE_DATAC/</span>
<span class="nv">target-prefix</span><span class="o">=</span><span class="s">foo://hello/</span>

<span class="c1"># Archive a file to a file</span>
<span class="nt">[arch:world.out]</span>
<span class="nv">source</span><span class="o">=</span><span class="s">hello/world.out</span>

<span class="c1"># Auto gzip</span>
<span class="nt">[arch:planet.out.gz]</span>
<span class="nv">source</span><span class="o">=</span><span class="s">hello/planet.out</span>

<span class="c1"># Archive files matched by a glob to a directory</span>
<span class="nt">[arch:worlds/]</span>
<span class="nv">source</span><span class="o">=</span><span class="s">hello/worlds/*</span>

<span class="c1"># Archive multiple files matched by globs or names to a directory</span>
<span class="nt">[arch:worlds/]</span>
<span class="nv">source</span><span class="o">=</span><span class="s">hello/worlds/* greeting/worlds/* hi/worlds/*</span>

<span class="c1"># As above, but &quot;greeting/worlds/*&quot; may return an empty list</span>
<span class="nt">[arch:worlds/]</span>
<span class="nv">source</span><span class="o">=</span><span class="s">hello/worlds/* (greeting/worlds/*) hi/worlds/*</span>

<span class="c1"># Target is optional, implied that sources may all be missing</span>
<span class="nt">[arch:(black-box/)]</span>
<span class="nv">source</span><span class="o">=</span><span class="s">cats.txt dogs.txt</span>

<span class="c1"># Auto tar-gzip</span>
<span class="nt">[arch:galaxies.tar.gz]</span>
<span class="nv">source-prefix</span><span class="o">=</span><span class="s">hello/</span>
<span class="nv">source</span><span class="o">=</span><span class="s">galaxies/*</span>
<span class="c1"># File with multiple galaxies may be large, don&#39;t do its checksum</span>
<span class="nv">update-check</span><span class="o">=</span><span class="s">mtime+size</span>

<span class="c1"># Force gzip each source file</span>
<span class="nt">[arch:stars/]</span>
<span class="nv">source</span><span class="o">=</span><span class="s">stars/*</span>
<span class="nv">compress</span><span class="o">=</span><span class="s">gzip</span>

<span class="c1"># Source name transformation</span>
<span class="nt">[arch:moons.tar.gz]</span>
<span class="nv">source</span><span class="o">=</span><span class="s">moons/*</span>
<span class="nv">rename-format</span><span class="o">=</span><span class="s">%(cycle)s-%(name)s</span>
<span class="nv">source-edit-format</span><span class="o">=</span><span class="s">sed &#39;s/Hello/Greet/g&#39; %(in)s &gt;%(out)s</span>

<span class="c1"># Source name transformation with a rename-parser</span>
<span class="nt">[arch:unknown/stuff.pax]</span>
<span class="nv">rename-format</span><span class="o">=</span><span class="s">hello/%(cycle)s-%(name_head)s%(name_tail)s</span>
<span class="nv">rename-parser</span><span class="o">=</span><span class="s">^(?P&lt;name_head&gt;stuff)ing(?P&lt;name_tail&gt;-.*)$</span>
<span class="nv">source</span><span class="o">=</span><span class="s">stuffing-*.txt</span>

<span class="c1"># ...</span>
</pre></div>
</div>




</article>
<article class="slide level-2" id="output">

<h2>Output<a class="headerlink" href="../../../html/api/built-in/rose_arch.html#output" title="View HTML">ยง</a></h2>

<p>On completion, <a class="reference internal" href="#rose:app:rose_arch" title="rose:app:rose_arch"><code class="xref rose rose-app docutils literal notranslate"><span class="pre">rose_arch</span></code></a> writes a status summary for each
target to the standard output, which looks like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0 foo:///fred/my-su173/output0.tar.gz [compress=tar.gz]
+ foo:///fred/my-su173/output1.tar.gz [compress=tar.gz, t(init)=2012-12-02T20:02:20Z, dt(tran)=5s, dt(arch)=10s, ret-code=0]
+       output1/earth.txt (output1/human.txt)
+       output1/venus.txt (output1/woman.txt)
+       output1/mars.txt (output1/man.txt)
= foo:///fred/my-su173/output2.tar.gz [compress=tar.gz]
! foo:///fred/my-su173/output3.tar.gz [compress=tar.gz]
</pre></div>
</div>
<p>The first column is a status symbol, where:</p>
<dl class="docutils">
<dt>0</dt>
<dd>An optional target has no real source, and is skipped.</dd>
<dt>+</dt>
<dd>A target is added or updated.</dd>
<dt>=</dt>
<dd>A target is not updated, as it was previously successfully updated with
the same sources.</dd>
<dt>!</dt>
<dd>Error updating this target.</dd>
</dl>
<p>If the first column and the second column are separated by a space character,
the second column is a target. If the first column and the second column are
separated by a tab character, the second column is a source in the target
above.</p>
<p>For a target line, the third column contains the compress scheme, the
initial time, the duration taken to transform the sources, the duration
taken to run the archive command and the return code of the archive
command. For a source line, the third column contains the original name of
the source.</p>




</article>
<article class="slide level-2" id="configuration">

<h2>Configuration<a class="headerlink" href="../../../html/api/built-in/rose_arch.html#configuration" title="View HTML">ยง</a></h2>

<dl class="app">
<dt id="rose:app:rose_arch">
<em class="property">Rose App </em><code class="descname">rose_arch</code></dt>
<dd><dl class="conf">
<dt id="rose:conf:rose_arch[arch]">
<em class="property">Config </em><code class="descname">[arch]</code><em class="property">(alternate: arch:TARGET)</em></dt>
<dd><dl class="conf">
<dt id="rose:conf:rose_arch[arch]command-format">
<em class="property">Config </em><code class="descname">command-format</code><em class="property">= FORMAT</em></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Compulsory:</th><td class="field-body">True</td>
</tr>
</tbody>
</table>
<p>A Pythonic <code class="docutils literal notranslate"><span class="pre">printf</span></code>-style format string to construct the archive
command. It must contain the placeholders <code class="docutils literal notranslate"><span class="pre">%(sources)s</span></code>
and <code class="docutils literal notranslate"><span class="pre">%(target)s</span></code> for substitution of the sources and the target
respectively.</p>
</dd></dl>

<dl class="conf">
<dt id="rose:conf:rose_arch[arch]compress">
<em class="property">Config </em><code class="descname">compress</code><em class="property">= pax|tar|pax.gz|tar.gz|tgz|gz</em></dt>
<dd><p>If specified, compress source files to the given scheme before
sending them to the archive. If not specified, the compress
scheme is automatically determined by the file extension of
the target, if it matches one of the allowed values. For the
<code class="docutils literal notranslate"><span class="pre">pax|tar</span></code> scheme, the sources will be placed in a TAR archive
before being sent to the target. For the <code class="docutils literal notranslate"><span class="pre">pax.gz|tar.gz|tgz</span></code>
scheme, the sources will be placed in a TAR-GZIP file before
being sent to the target. For the <code class="docutils literal notranslate"><span class="pre">gz</span></code> scheme, each source
file will be compressed by GZIP before being sent to the target.</p>
</dd></dl>

<dl class="conf">
<dt id="rose:conf:rose_arch[arch]rename-format">
<em class="property">Config </em><code class="descname">rename-format</code></dt>
<dd><p>If specified, the source files will be renamed according to the
specified format. The format string should be a Pythonic
<code class="docutils literal notranslate"><span class="pre">printf</span></code>-style format string. It may contain the placeholder
<code class="docutils literal notranslate"><span class="pre">%(cycle)s</span></code> (for the current <span class="target" id="index-0"></span><a class="reference internal" href="../environment-variables.html#envvar-ROSE_TASK_CYCLE_TIME"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">ROSE_TASK_CYCLE_TIME</span></code></a>, the
placeholder <code class="docutils literal notranslate"><span class="pre">%(name)s</span></code> for the name of the file, and/or named
placeholders that are generated by <a class="reference internal" href="#rose:conf:rose_arch[arch]rename-parser" title="rose:conf:rose_arch[arch]rename-parser"><code class="xref rose rose-conf docutils literal notranslate"><span class="pre">rename-parser</span></code></a>.</p>
</dd></dl>

<dl class="conf">
<dt id="rose:conf:rose_arch[arch]rename-parser">
<em class="property">Config </em><code class="descname">rename-parser</code></dt>
<dd><p>Ignored if <code class="docutils literal notranslate"><span class="pre">rename-format</span></code> is not specified. Specify a regular
expression to parse the name of a source. The regular expression
should do named captures of strings from source file names,
which can then be used to substitute named placeholders in the
corresponding <a class="reference internal" href="#rose:conf:rose_arch[arch]rename-format" title="rose:conf:rose_arch[arch]rename-format"><code class="xref rose rose-conf docutils literal notranslate"><span class="pre">rename-format</span></code></a>.</p>
</dd></dl>

<dl class="conf">
<dt id="rose:conf:rose_arch[arch]source">
<em class="property">Config </em><code class="descname">source</code><em class="property">= NAME</em></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Compolsory:</th><td class="field-body">True</td>
</tr>
</tbody>
</table>
<p>Specify a list of space delimited source file names and/or globs
for matching source file names. (File names with space or quote
characters can be escaped using quotes or backslashes, like in
a shell.) Paths, if not absolute (beginning with a <code class="docutils literal notranslate"><span class="pre">/</span></code>), are
assumed to be relative to <span class="target" id="index-1"></span><a class="reference internal" href="../environment-variables.html#envvar-ROSE_SUITE_DIR"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">ROSE_SUITE_DIR</span></code></a> or to
<code class="docutils literal notranslate"><span class="pre">$ROSE_SUITE_DIR/PREFIX</span></code> if
<a class="reference internal" href="#rose:conf:rose_arch[arch]source-prefix" title="rose:conf:rose_arch[arch]source-prefix"><code class="xref rose rose-conf docutils literal notranslate"><span class="pre">source-prefix</span></code></a> is specified.
If a name or glob is given in a pair of brackets, e.g.
<code class="docutils literal notranslate"><span class="pre">(hello-world.*)</span></code>, the source is considered optional and will
not cause a failure if it does not match any source file names.
However, a compulsory target that ends up with no matching source
file will be considered a failure.</p>
</dd></dl>

<dl class="conf">
<dt id="rose:conf:rose_arch[arch]source-edit-format">
<em class="property">Config </em><code class="descname">source-edit-format</code><em class="property">= FORMAT</em></dt>
<dd><p>A Pythonic <code class="docutils literal notranslate"><span class="pre">printf</span></code>-style format string to construct a command to
edit or modify the content of source files before archiving them.
It must contain the placeholders <code class="docutils literal notranslate"><span class="pre">%(in)s</span></code> and <code class="docutils literal notranslate"><span class="pre">%(out)s</span></code> for
substitution of the path to the source file and the path to the
modified source file (which will be created in a temporary working
directory).</p>
</dd></dl>

<dl class="conf">
<dt id="rose:conf:rose_arch[arch]source-prefix">
<em class="property">Config </em><code class="descname">source-prefix</code><em class="property">= PREFIX</em></dt>
<dd><p>Add a prefix to each value in a source declaration. A trailing
slash should be added for a directory. Paths are assumed to be
relative to <span class="target" id="index-2"></span><a class="reference internal" href="../environment-variables.html#envvar-ROSE_SUITE_DIR"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">ROSE_SUITE_DIR</span></code></a>. This setting serves two
purposes. It provides a way to avoid typing the same thing
repeatedly. It also modifies the name-spaces of the sources if
the target is in a TAR or TAR-GZIP file. In the absence of this
setting, the name of a source in a TAR or TAR-GZIP file is the
path relative to <span class="target" id="index-3"></span><a class="reference internal" href="../environment-variables.html#envvar-ROSE_SUITE_DIR"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">ROSE_SUITE_DIR</span></code></a>. By specifying this
setting, the source names in a TAR or TAR-GZIP file will be
shortened by the prefix.</p>
</dd></dl>

<dl class="conf">
<dt id="rose:conf:rose_arch[arch]target-prefix">
<em class="property">Config </em><code class="descname">target-prefix</code><em class="property">= PREFIX</em></dt>
<dd><p>Add a prefix to each target declaration. This setting provides
a way to avoid typing the same thing repeatedly. A trailing
slash (or whatever is relevant for the archiving system) should
be added for a directory.</p>
</dd></dl>

<dl class="conf">
<dt id="rose:conf:rose_arch[arch]update-check">
<em class="property">Config </em><code class="descname">update-check</code><em class="property">= mtime+size|md5|sha1|...</em></dt>
<dd><p>Specify the method for checking whether a source has changed
since the previous run. If the value is mtime+size, the
application will use the modified time and size of the source,
which is useful for large files, but is less correct. Otherwise,
the value, if specified, should be the name of a hash object in
Pythonโs <a class="reference external" href="https://docs.python.org/2/library/hashlib.html">hashlib</a>, such as <code class="docutils literal notranslate"><span class="pre">md5</span></code> (default), <code class="docutils literal notranslate"><span class="pre">sha1</span></code>, etc.
In this mode, the application will use the checksum (based on
the specified hashing method) of the content of each source file
to determine if it has changed or not.</p>
</dd></dl>

</dd></dl>

</dd></dl>





</article>

</section>

<section id="slide_notes">

</section>

  </body>
</html>